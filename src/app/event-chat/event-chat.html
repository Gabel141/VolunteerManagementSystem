<div class="event-chat card mt-4">
  <div class="card-body d-flex flex-column p-2">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0">Event Chat</h6>
    </div>
    <div *ngIf="showOnlineList()" class="mb-2">
      <div class="card card-sm p-2 shadow-sm">
        <div *ngIf="onlineUsers().length === 0" class="small text-muted">No one online</div>
        <div *ngFor="let u of onlineUsers()" class="d-flex align-items-center gap-2 py-1">
          <div class="small online-dot-list">‚óè</div>
          <div class="small">{{ u.displayName || u.uid }}</div>
        </div>
      </div>
    </div>

    <div class="chat-messages mb-2" style="max-height:320px; overflow:auto;">
      <button *ngIf="messages().length >= pageSize" (click)="loadOlderMessages()" class="btn btn-sm btn-link">‚Üë Load more</button>

      <ng-container *ngFor="let m of (messages().concat(pendingMessages()))">
        <div class="chat-message mb-3" [class.pending]="m.status === 'pending'" [class.failed]="m.status === 'failed'">
          <div [class]="'d-flex align-items-start gap-2 ' + (isCreatorMessage(m) ? 'creator-message' : '')">
            <div class="chat-avatar position-relative"
                 (mouseenter)="showAvatarPopover(m.senderUid, $event)"
                 (mouseleave)="hideAvatarPopover()"
                 (click)="showAvatarPopover(m.senderUid, $event)">
              <img *ngIf="m.senderPhoto" [src]="m.senderPhoto" alt="" />
              <div *ngIf="!m.senderPhoto" class="avatar-fallback">{{ (m.senderName || '').charAt(0) }}</div>
              <span *ngIf="isUserOnline(m.senderUid)" class="online-dot" title="Online now"></span>
            </div>
            <div class="chat-bubble flex-fill">
              <div class="d-flex justify-content-between align-items-start mb-1">
                <div class="chat-meta small text-muted">{{ m.senderName }} <span *ngIf="m.edited" class="badge bg-secondary ms-1">edited</span></div>
                <div class="chat-meta small text-muted">{{ m.createdAt ? (m.createdAt | date:'short') : '' }}</div>
              </div>

              <div *ngIf="!m._editing" class="chat-text mb-2">{{ m.text }}</div>
              <div *ngIf="m.attachmentUrl" class="mb-2">
                <a [href]="m.attachmentUrl" target="_blank" class="btn btn-sm btn-outline-primary">üìé {{ m.attachmentName || 'Attachment' }}</a>
              </div>

              <div *ngIf="m._editing" class="mt-2 d-flex gap-2 mb-2">
                <input class="form-control form-control-sm" [(ngModel)]="m._editText" name="edit-{{m.id}}" />
                <button class="btn btn-sm btn-success" (click)="editMessage(m.id, m._editText); m._editing=false">‚úì</button>
                <button class="btn btn-sm btn-secondary" (click)="m._editing=false">‚úï</button>
              </div>

              <!-- Reactions display -->
              <div *ngIf="m.reactions && Object.keys(m.reactions).length" class="mb-2 d-flex gap-1 flex-wrap">
                <button *ngFor="let emoji of Object.keys(m.reactions)" (click)="toggleReaction(m.id, emoji)" class="btn btn-sm btn-outline-secondary reactions-btn">
                  {{emoji}} <span class="ms-1">{{ m.reactions[emoji]?.length || 0 }}</span>
                </button>
              </div>

              <div class="d-flex gap-2 align-items-center flex-wrap">
                <div class="reactions-picker position-relative">
                  <button class="btn btn-sm btn-light" (click)="toggleEmojiPicker()" title="Add reaction">üòä</button>
                  <div *ngIf="showEmojiPicker()" class="emoji-picker">
                    <button *ngFor="let emoji of emojiPresets" (click)="toggleReaction(m.id, emoji)" class="emoji-btn">{{ emoji }}</button>
                  </div>
                </div>

                <div class="ms-auto d-flex gap-1">
                  <button *ngIf="canModifyMessage(m) && !m._editing" class="btn btn-sm btn-link text-secondary" (click)="m._editing=true; m._editText = m.text">‚úèÔ∏è</button>
                  <button *ngIf="canModifyMessage(m)" class="btn btn-sm btn-link text-danger" (click)="deleteMessage(m.id)">üóëÔ∏è</button>
                  <button *ngIf="creatorUid && creatorUid === (auth.currentUser?.uid) && m.senderUid !== auth.currentUser?.uid" class="btn btn-sm btn-outline-danger" (click)="banUser(m.senderUid)" title="Ban user">Ban</button>
                  <button *ngIf="creatorUid && creatorUid === (auth.currentUser?.uid) && m.senderUid !== auth.currentUser?.uid" class="btn btn-sm btn-outline-warning" (click)="muteUser(m.senderUid)" title="Mute user">Mute</button>

                  <div *ngIf="m.status === 'failed'" class="ms-2 d-inline-flex gap-1">
                    <button class="btn btn-sm btn-outline-primary" (click)="retryPending(m.clientId)">Retry</button>
                    <button class="btn btn-sm btn-outline-danger" (click)="removePending(m.clientId)">Remove</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <div id="chat-end-{{eventId}}"></div>
    </div>

    <div *ngIf="errorMessage()" class="alert alert-danger py-2 mb-2">{{ errorMessage() }}</div>

    <form class="chat-input d-flex gap-2 align-items-center" (submit)="$event.preventDefault(); sendMessage();">
      <input class="form-control form-control-sm flex-grow-1" placeholder="Write a message..." [(ngModel)]="newMessage" name="message" />

      <button class="btn btn-sm btn-primary" type="button" (click)="sendMessage()" [disabled]="loading() || (!newMessage() && !uploading())">Send</button>
    </form>
    <div *ngIf="uploading()" class="small mt-2 text-muted">Uploading: {{uploadProgress()}}%</div>
    <div class="avatar-popover" *ngIf="popoverVisible" [ngStyle]="popoverStyle">
      <div class="popover-card p-2 shadow-sm bg-white rounded">
        <div class="d-flex gap-2 align-items-center">
          <img *ngIf="popoverData?.profilePicture" [src]="popoverData.profilePicture" class="rounded-circle" style="width:48px;height:48px;object-fit:cover;" />
          <div>
            <div class="fw-bold">{{ popoverData?.displayName || popoverData?.uid }}</div>
            <div class="small text-muted">{{ popoverData?.bio || '' }}</div>
            <a class="small mt-1 d-inline-block" [routerLink]="['/profile', popoverData?.uid]">View Profile</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

